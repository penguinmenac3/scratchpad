var J=Object.defineProperty;var $=(r,i,t)=>i in r?J(r,i,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[i]=t;var u=(r,i,t)=>($(r,typeof i!="symbol"?i+"":i,t),t);(function(){const i=document.createElement("link").relList;if(i&&i.supports&&i.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))e(s);new MutationObserver(s=>{for(const o of s)if(o.type==="childList")for(const n of o.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&e(n)}).observe(document,{childList:!0,subtree:!0});function t(s){const o={};return s.integrity&&(o.integrity=s.integrity),s.referrerpolicy&&(o.referrerPolicy=s.referrerpolicy),s.crossorigin==="use-credentials"?o.credentials="include":s.crossorigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function e(s){if(s.ep)return;s.ep=!0;const o=t(s);fetch(s.href,o)}})();class m{constructor(){}static APPLY_COUNTED(i,t){return t.replace("{count}",i.toString())}}u(m,"TIME_LOCALE","en"),u(m,"TIME_YESTERDAY","yesterday"),u(m,"TIME_HOURS_AGO","{count} hour(s) ago"),u(m,"TIME_MINUTES_AGO","{count} minute(s) ago"),u(m,"TIME_SECONDS_AGO","{count} second(s) ago"),u(m,"TIME_TODAY_AT","today at"),u(m,"TIME_JUST_NOW","just now"),u(m,"APPNAME","ScratchPad"),u(m,"LOGIN_KNOWN_CONNECTIONS","Reuse Connection"),u(m,"LOGIN_ALL_CONNECTIONS","All"),u(m,"LOGIN_SESSION_NAME","Session Name"),u(m,"LOGIN_API_ENDPOINT_LABEL","API Endpoint URL"),u(m,"LOGIN_API_TOKEN_LABEL","API Token"),u(m,"LOGIN_SUBMIT","Add Connection"),u(m,"LOGIN_ERROR_MISSING_INPUTS","You must provide all fields (session name, api endpoint and api token)."),u(m,"LOGIN_ERROR_LOGIN_FAILED","The provided login information is wrong. Is the URL and API token correct?"),u(m,"LOGIN_OFFLINE_MODAL_QUESTION","Cannot connect to server. Do you want to continue in offline mode? Offline mode might show you outdated files and data."),u(m,"LOGIN_OFFLINE_MODAL_CONFIRM","Continue offline"),u(m,"LOGIN_OFFLINE_MODAL_CANCEL","Return to login"),u(m,"NOTEPAD_CLEAR_QUESTION","Are you sure you want to clear the document? This will delete all strokes and content of it irreversibly!"),u(m,"NOTEPAD_CLEAR_CONFIRM","Yes, delete it"),u(m,"NOTEPAD_CLEAR_CANCEL","No, keep it"),u(m,"NOTEPAD_IMPORT_QUESTION","What file do you want to import (*.spf.svg or *.spf)? Note: Importing will overwrite content currently displayed."),u(m,"NOTEPAD_IMPORT_CONFIRM","Import"),u(m,"NOTEPAD_IMPORT_UNSUPPORTED_FILE","ERROR: Only *.spf and *.spf.svg are supported filetypes.");class F extends m{}u(F,"TIME_LOCALE","de"),u(F,"APPNAME","Notizblock");let T=m;function Z(){switch(localStorage.language){case"de":T=F;break;case"en":case"us":default:T=m;break}}class C{constructor(i,t="",e=""){u(this,"parent",null);u(this,"htmlElement");u(this,"displayStyle","none");this.htmlElement=document.createElement(i),this.htmlElement.innerHTML=t,e!=""&&this.setClass(e)}add(i){this.htmlElement.appendChild(i.htmlElement),i.parent=this}remove(i){this.htmlElement.removeChild(i.htmlElement),i.parent=null}isVisible(){return this.htmlElement.style.display.toLowerCase()!="none"}hide(){this.isVisible()&&(this.displayStyle=this.htmlElement.style.display,this.htmlElement.style.display="None")}show(){this.displayStyle.toLowerCase()!="none"&&(this.htmlElement.style.display=this.displayStyle)}update(i,t){}select(){this.setClass("selected")}unselect(){this.unsetClass("selected")}setClass(i){this.hasClass(i)||this.htmlElement.classList.add(i)}unsetClass(i){this.hasClass(i)&&this.htmlElement.classList.remove(i)}hasClass(i){return this.htmlElement.classList.contains(i)}}class b{static register(i,t){this.registry.has(i)||this.registry.set(i,[]),this.registry.get(i).push(t)}static send(i,t){let e=this.registry.get(i)??[];for(let s of e)s(i,t);if(t.allowNetwork){let s=this.registry.get("network")??[];for(let o of s)o(i,t)}}}u(b,"registry",new Map);class L extends C{constructor(i,t=""){super("a",i,t),this.htmlElement.onclick=e=>{e.stopPropagation(),this.onClick()}}onClick(){console.log("Buttom::onClick: Not implemented! Must be implemented by subclass.")}}class tt extends C{constructor(i,t,e,s=""){super("input"),this.htmlElement.name=i,this.htmlElement.placeholder=t,this.htmlElement.type=e,s!=""&&this.setClass(s),this.htmlElement.oninput=()=>{this.onChange(this.htmlElement.value)},this.htmlElement.onchange=()=>{this.onChangeDone(this.htmlElement.value)}}value(i=void 0){return i!==void 0&&(this.htmlElement.value=i),this.htmlElement.value}onChange(i){}onChangeDone(i){}}const I=class extends C{constructor(t,e,s="",o=!1,n=!1){super("div",s,"tool");u(this,"popup",null);this.id=t,this.selectable=e,this.togglable=n,o&&(this.htmlElement.style.float="right"),e&&I.selectableTools.push(this.id),this.htmlElement.onclick=a=>{this.onClick()},b.register("toolbar/change",this.onSelectionChanged.bind(this)),b.register("toolbar/setting",this.onSettingChanged.bind(this))}onClick(){return this.togglable&&(this.hasClass("selected-tool")?(this.unsetClass("selected-tool"),this.unsetClass("selected-tool-good")):(this.setClass("selected-tool"),this.setClass("selected-tool-good"))),this.popup&&(!this.selectable||this.hasClass("selected-tool"))&&this.popup.show(),b.send("toolbar/change",{type:"string",data:this.id,allowNetwork:!1}),!0}onSelectionChanged(t,e){if(t=="toolbar/change"&&e.type=="string"){if(I.selectableTools.indexOf(e.data)==-1)return;this.togglable||(e.data==this.id?this.setClass("selected-tool"):this.unsetClass("selected-tool"))}}onSettingChanged(t,e){t=="toolbar/setting"&&e.type=="setting"&&e.data.id==this.id&&e.data.color&&(this.htmlElement.style.fill="var(--color-"+e.data.color+"-font)")}addPopup(t){this.popup!=null&&alert("CODING ERROR! Tool already has a popup attached!"),this.add(t),this.popup=t,this.popup.setParent(this.id)}};let E=I;u(E,"selectableTools",[]);class N extends E{constructor(t,e="",s=""){super(t,!1,e+"&ensp;"+s);u(this,"parentMenu",null);this.id=t,this.unsetClass("tool"),this.setClass("toolWithText")}setParentMenu(t){this.parentMenu=t}onClick(){return window.setTimeout(()=>{var t;return(t=this.parentMenu)==null?void 0:t.hide()},10),super.onClick()}}class et extends C{constructor(t=[]){super("div","","toolPopup");u(this,"grayOut");this.children=t,t.forEach(e=>{this.add(e)}),this.grayOut=document.createElement("div"),this.grayOut.classList.add("toolPopupGrayout"),this.grayOut.onclick=this.hide.bind(this),document.getElementById("global").appendChild(this.grayOut),this.hide()}setParent(t){this.children.forEach(e=>{e.setParentTool(t,this)})}show(){super.show(),this.grayOut.style.display="block"}hide(){super.hide(),this.grayOut.style.display="none"}}class st extends C{constructor(t=[]){super("div","","menuPopup");u(this,"grayOut");t.forEach(e=>{e.setParentMenu(this),this.add(e)}),this.grayOut=document.createElement("div"),this.grayOut.classList.add("toolPopupGrayout"),this.grayOut.onclick=this.hide.bind(this),document.getElementById("global").appendChild(this.grayOut),this.hide()}setParent(t){}show(){super.show(),this.grayOut.style.display="block"}hide(){super.hide(),this.grayOut.style.display="none"}}class U extends L{constructor(t){super(t,"tool");u(this,"parentId","");u(this,"parentPopup",null)}setParentTool(t,e){this.parentId=t,this.parentPopup=e}}class S extends U{constructor(i,t,e=!1){super(i),this.color=t,this.htmlElement.style.fill="var(--color-"+t+"-font)",e&&window.setTimeout(this.onClick.bind(this),100)}onClick(){window.setTimeout(()=>{var i;return(i=this.parentPopup)==null?void 0:i.hide()},10),b.send("toolbar/setting",{type:"setting",data:{id:this.parentId,color:this.color},allowNetwork:!1})}}class z extends U{constructor(i,t,e=!1){super(i),this.size=t,e&&window.setTimeout(this.onClick.bind(this),100)}onClick(){window.setTimeout(()=>{var i;return(i=this.parentPopup)==null?void 0:i.hide()},10),b.send("toolbar/setting",{type:"setting",data:{id:this.parentId,size:this.size},allowNetwork:!1})}}class ot extends C{constructor(i=!1){super("div","","spacer"),i&&(this.htmlElement.style.float="right")}}let it='<svg xmlns="http://www.w3.org/2000/svg" height="1em" viewBox="0 0 448 512"><!--! Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2023 Fonticons, Inc. --><path d="M257.5 445.1l-22.2 22.2c-9.4 9.4-24.6 9.4-33.9 0L7 273c-9.4-9.4-9.4-24.6 0-33.9L201.4 44.7c9.4-9.4 24.6-9.4 33.9 0l22.2 22.2c9.5 9.5 9.3 25-.4 34.3L136.6 216H424c13.3 0 24 10.7 24 24v32c0 13.3-10.7 24-24 24H136.6l120.5 114.8c9.8 9.3 10 24.8.4 34.3z"/></svg>',nt='<svg xmlns="http://www.w3.org/2000/svg" height="1em" viewBox="0 0 512 512"><!--! Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2023 Fonticons, Inc. --><path d="M290.74 93.24l128.02 128.02-277.99 277.99-114.14 12.6C11.35 513.54-1.56 500.62.14 485.34l12.7-114.22 277.9-277.88zm207.2-19.06l-60.11-60.11c-18.75-18.75-49.16-18.75-67.91 0l-56.55 56.55 128.02 128.02 56.55-56.55c18.75-18.76 18.75-49.16 0-67.91z"/></svg>',lt='<svg xmlns="http://www.w3.org/2000/svg" height="1em" viewBox="0 0 544 512"><!--! Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2023 Fonticons, Inc. --><path d="M0 479.98L99.92 512l35.45-35.45-67.04-67.04L0 479.98zm124.61-240.01a36.592 36.592 0 0 0-10.79 38.1l13.05 42.83-50.93 50.94 96.23 96.23 50.86-50.86 42.74 13.08c13.73 4.2 28.65-.01 38.15-10.78l35.55-41.64-173.34-173.34-41.52 35.44zm403.31-160.7l-63.2-63.2c-20.49-20.49-53.38-21.52-75.12-2.35L190.55 183.68l169.77 169.78L530.27 154.4c19.18-21.74 18.15-54.63-2.35-75.13z"/></svg>',at='<svg xmlns="http://www.w3.org/2000/svg" height="1em" viewBox="0 0 512 512"><!--! Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2023 Fonticons, Inc. --><path d="M497.941 273.941c18.745-18.745 18.745-49.137 0-67.882l-160-160c-18.745-18.745-49.136-18.746-67.883 0l-256 256c-18.745 18.745-18.745 49.137 0 67.882l96 96A48.004 48.004 0 0 0 144 480h356c6.627 0 12-5.373 12-12v-40c0-6.627-5.373-12-12-12H355.883l142.058-142.059zm-302.627-62.627l137.373 137.373L265.373 416H150.628l-80-80 124.686-124.686z"/></svg>',rt='<svg xmlns="http://www.w3.org/2000/svg" height="1em" viewBox="0 0 256 512"><!--! Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2023 Fonticons, Inc. --><path d="M145.6 7.7C141 2.8 134.7 0 128 0s-13 2.8-17.6 7.7l-104 112c-6.5 7-8.2 17.2-4.4 25.9S14.5 160 24 160H80V352H24c-9.5 0-18.2 5.7-22 14.4s-2.1 18.9 4.4 25.9l104 112c4.5 4.9 10.9 7.7 17.6 7.7s13-2.8 17.6-7.7l104-112c6.5-7 8.2-17.2 4.4-25.9s-12.5-14.4-22-14.4H176V160h56c9.5 0 18.2-5.7 22-14.4s2.1-18.9-4.4-25.9l-104-112z"/></svg>',ht='<svg xmlns="http://www.w3.org/2000/svg" height="1em" viewBox="0 0 384 512"><!--! Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2023 Fonticons, Inc. --><path d="M64 64V241.6c5.2-1 10.5-1.6 16-1.6H96V208 64c0-8.8-7.2-16-16-16s-16 7.2-16 16zM80 288c-17.7 0-32 14.3-32 32c0 0 0 0 0 0v24c0 66.3 53.7 120 120 120h48c52.5 0 97.1-33.7 113.4-80.7c-3.1 .5-6.2 .7-9.4 .7c-20 0-37.9-9.2-49.7-23.6c-9 4.9-19.4 7.6-30.3 7.6c-15.1 0-29-5.3-40-14c-11 8.8-24.9 14-40 14H120c-13.3 0-24-10.7-24-24s10.7-24 24-24h40c8.8 0 16-7.2 16-16s-7.2-16-16-16H120 80zM0 320s0 0 0 0c0-18 6-34.6 16-48V64C16 28.7 44.7 0 80 0s64 28.7 64 64v82c5.1-1.3 10.5-2 16-2c25.3 0 47.2 14.7 57.6 36c7-2.6 14.5-4 22.4-4c20 0 37.9 9.2 49.7 23.6c9-4.9 19.4-7.6 30.3-7.6c35.3 0 64 28.7 64 64v64 24c0 92.8-75.2 168-168 168H168C75.2 512 0 436.8 0 344V320zm336-64c0-8.8-7.2-16-16-16s-16 7.2-16 16v48 16c0 8.8 7.2 16 16 16s16-7.2 16-16V256zM160 240c5.5 0 10.9 .7 16 2v-2V208c0-8.8-7.2-16-16-16s-16 7.2-16 16v32h16zm64 24v40c0 8.8 7.2 16 16 16s16-7.2 16-16V256 240c0-8.8-7.2-16-16-16s-16 7.2-16 16v24z"/></svg>',ct='<svg xmlns="http://www.w3.org/2000/svg" height="1em" viewBox="0 0 448 512"><!--! Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2023 Fonticons, Inc. --><path d="M433.941 129.941l-83.882-83.882A48 48 0 0 0 316.118 32H48C21.49 32 0 53.49 0 80v352c0 26.51 21.49 48 48 48h352c26.51 0 48-21.49 48-48V163.882a48 48 0 0 0-14.059-33.941zM272 80v80H144V80h128zm122 352H54a6 6 0 0 1-6-6V86a6 6 0 0 1 6-6h42v104c0 13.255 10.745 24 24 24h176c13.255 0 24-10.745 24-24V83.882l78.243 78.243a6 6 0 0 1 1.757 4.243V426a6 6 0 0 1-6 6zM224 232c-48.523 0-88 39.477-88 88s39.477 88 88 88 88-39.477 88-88-39.477-88-88-88zm0 128c-22.056 0-40-17.944-40-40s17.944-40 40-40 40 17.944 40 40-17.944 40-40 40z"/></svg>',dt='<svg xmlns="http://www.w3.org/2000/svg" height="1em" viewBox="0 0 448 512"><!--!Font Awesome Free 6.5.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2024 Fonticons, Inc.--><path d="M135.2 17.7L128 32H32C14.3 32 0 46.3 0 64S14.3 96 32 96H416c17.7 0 32-14.3 32-32s-14.3-32-32-32H320l-7.2-14.3C307.4 6.8 296.3 0 284.2 0H163.8c-12.1 0-23.2 6.8-28.6 17.7zM416 128H32L53.2 467c1.6 25.3 22.6 45 47.9 45H346.9c25.3 0 46.3-19.7 47.9-45L416 128z"/></svg>',ut='<svg xmlns="http://www.w3.org/2000/svg" height="1em" viewBox="0 0 576 512"><!--!Font Awesome Free 6.5.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2024 Fonticons, Inc.--><path d="M0 64C0 28.7 28.7 0 64 0H224V128c0 17.7 14.3 32 32 32H384V288H216c-13.3 0-24 10.7-24 24s10.7 24 24 24H384V448c0 35.3-28.7 64-64 64H64c-35.3 0-64-28.7-64-64V64zM384 336V288H494.1l-39-39c-9.4-9.4-9.4-24.6 0-33.9s24.6-9.4 33.9 0l80 80c9.4 9.4 9.4 24.6 0 33.9l-80 80c-9.4 9.4-24.6 9.4-33.9 0s-9.4-24.6 0-33.9l39-39H384zm0-208H256V0L384 128z"/></svg>',pt='<svg xmlns="http://www.w3.org/2000/svg" height="1em" viewBox="0 0 512 512"><!--!Font Awesome Free 6.5.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2024 Fonticons, Inc.--><path d="M128 64c0-35.3 28.7-64 64-64H352V128c0 17.7 14.3 32 32 32H512V448c0 35.3-28.7 64-64 64H192c-35.3 0-64-28.7-64-64V336H302.1l-39 39c-9.4 9.4-9.4 24.6 0 33.9s24.6 9.4 33.9 0l80-80c9.4-9.4 9.4-24.6 0-33.9l-80-80c-9.4-9.4-24.6-9.4-33.9 0s-9.4 24.6 0 33.9l39 39H128V64zm0 224v48H24c-13.3 0-24-10.7-24-24s10.7-24 24-24H128zM512 128H384V0L512 128z"/></svg>',O;const mt=new Uint8Array(16);function ft(){if(!O&&(O=typeof crypto<"u"&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!O))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return O(mt)}const P=[];for(let r=0;r<256;++r)P.push((r+256).toString(16).slice(1));function yt(r,i=0){return(P[r[i+0]]+P[r[i+1]]+P[r[i+2]]+P[r[i+3]]+"-"+P[r[i+4]]+P[r[i+5]]+"-"+P[r[i+6]]+P[r[i+7]]+"-"+P[r[i+8]]+P[r[i+9]]+"-"+P[r[i+10]]+P[r[i+11]]+P[r[i+12]]+P[r[i+13]]+P[r[i+14]]+P[r[i+15]]).toLowerCase()}const gt=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto),H={randomUUID:gt};function W(r,i,t){if(H.randomUUID&&!i&&!r)return H.randomUUID();r=r||{};const e=r.random||(r.rng||ft)();if(e[6]=e[6]&15|64,e[8]=e[8]&63|128,i){t=t||0;for(let s=0;s<16;++s)i[t+s]=e[s];return i}return yt(e)}let wt="2",xt="3";class G{constructor(i,t,e,s=!1){this.id=e;let o=new E("tool_"+this.id,!0,t);i.add(o),s&&o.onClick()}register(i){i.set(this.id,this)}render(i){let t=i.bbox_xyxy[2]-i.bbox_xyxy[0],e=i.bbox_xyxy[3]-i.bbox_xyxy[1],s=document.createElement("canvas");return s.width=t,s.height=e,s.getContext("2d").clearRect(0,0,t,e),s}onStart(i,t,e,s,o,n,a){}onMove(i,t,e,s,o,n,a){}onEnd(i,t,e,s,o,n,a){}activate(){}deactivate(){}}class Y{constructor(i,t,e,s,o,n,a,l,h=!1){this.id=e,this.color=s,this.lineWidth=o,this.transparency=n;let c=new E("tool_"+this.id,!0,t);i.add(c),h&&c.onClick(),c.addPopup(new et([new S(t,"base",s=="base"),new S(t,"brand",s=="brand"),new S(t,"accent",s=="accent"),new S(t,"good",s=="good"),new S(t,"bad",s=="bad"),new z("o",a),new z("O",l)])),b.register("toolbar/setting",this.onSettingChanged.bind(this))}onSettingChanged(i,t){i=="toolbar/setting"&&t.type=="setting"&&t.data.id=="tool_"+this.id&&(t.data.color&&(this.color=t.data.color),t.data.size&&(this.lineWidth=t.data.size))}getTransparancy(){return this.transparency}register(i){i.set(this.id,this)}render(i){let t=i.bbox_xyxy[2]-i.bbox_xyxy[0],e=i.bbox_xyxy[3]-i.bbox_xyxy[1],s=document.createElement("canvas");return s.width=t,s.height=e,s.getContext("2d").clearRect(0,0,t,e),s}onStart(i,t,e,s,o,n,a){}onMove(i,t,e,s,o,n,a){}onEnd(i,t,e,s,o,n,a){}activate(){}deactivate(){}}function f(r){return Math.round(r*100)/100}let vt=.2;class Pt extends Y{constructor(t){super(t,nt,"pen","brand",.4,"FF",.4,.8,!0);u(this,"points",[]);u(this,"lastPoint",[0,0])}render(t){let e=10,s=(t.bbox_xyxy[2]-t.bbox_xyxy[0])*e,o=(t.bbox_xyxy[3]-t.bbox_xyxy[1])*e,n=document.createElement("canvas");n.width=s,n.height=o;let a=n.getContext("2d");a.clearRect(0,0,s,o);let l=getComputedStyle(document.body).getPropertyValue("--color-"+t.data[0]+"-font");a.strokeStyle=l+this.transparency,a.lineWidth=t.data[1]*e,a.beginPath();let h=!0;for(let c of t.data[2]){let d=c[0]*e,p=c[1]*e;h?(a.moveTo(d,p),h=!1):a.lineTo(d,p)}return a.stroke(),a.closePath(),n}onStart(t,e,s,o,n,a,l){let h=getComputedStyle(document.body).getPropertyValue("--color-"+this.color+"-font");e.strokeStyle=h+this.transparency,e.lineWidth=this.lineWidth/l,e.beginPath(),e.moveTo((s-n)/l,(o-a)/l),this.points.push([s,o]),this.lastPoint=[s,o]}onMove(t,e,s,o,n,a,l){let[h,c]=this.lastPoint;if(Math.sqrt((s-h)**2+(o-c)**2)<vt)return;e.lineTo((s-n)/l,(o-a)/l);let d=getComputedStyle(document.body).getPropertyValue("--color-"+this.color+"-font");e.strokeStyle=d+this.transparency,e.lineWidth=this.lineWidth/l,e.stroke(),this.points.push([s,o]),this.lastPoint=[s,o]}onEnd(t,e,s,o,n,a,l){e.lineTo((s-n)/l,(o-a)/l);let h=getComputedStyle(document.body).getPropertyValue("--color-"+this.color+"-font");e.strokeStyle=h+this.transparency,e.lineWidth=this.lineWidth/l,e.stroke(),e.closePath(),this.points.push([s,o]);let[c,d]=this.normalizePoints(this.points,this.lineWidth);this.points=[],t.addElements([{uuid:W(),type:this.id,layer:xt,bbox_xyxy:d,data:[this.color,this.lineWidth,c]}])}normalizePoints(t,e){let s=t[0][0],o=t[0][1],[n,a,l,h]=[s,o,s,o];for(let d of t)n=Math.min(n,d[0]),a=Math.min(a,d[1]),l=Math.max(l,d[0]),h=Math.max(h,d[1]);n-=5+e,a-=5+e,l+=5+e,h+=5+e;let c=[];n=f(n),l=f(l),a=f(a),h=f(h);for(let d of t)c.push([f(d[0]-n),f(d[1]-a)]);return[c,[n,a,l,h]]}activate(){}deactivate(){}}let _t=1;class bt extends Y{constructor(t){super(t,lt,"marker","accent",5,"77",5,10);u(this,"points",[]);u(this,"lastPoint",[0,0])}render(t){let e=5,s=(t.bbox_xyxy[2]-t.bbox_xyxy[0])*e,o=(t.bbox_xyxy[3]-t.bbox_xyxy[1])*e,n=document.createElement("canvas");n.width=s,n.height=o;let a=n.getContext("2d");a.clearRect(0,0,s,o);let l=getComputedStyle(document.body).getPropertyValue("--color-"+t.data[0]+"-font");a.strokeStyle=l+this.transparency,a.lineWidth=t.data[1]*e,a.beginPath();let h=!0;for(let c of t.data[2]){let d=c[0]*e,p=c[1]*e;h?(a.moveTo(d,p),h=!1):a.lineTo(d,p)}return a.stroke(),a.closePath(),n}onStart(t,e,s,o,n,a,l){let h=getComputedStyle(document.body).getPropertyValue("--color-"+this.color+"-font");e.strokeStyle=h+this.transparency,e.lineWidth=this.lineWidth/l,e.beginPath(),e.moveTo((s-n)/l,(o-a)/l),this.points.push([s,o]),this.lastPoint=[s,o]}onMove(t,e,s,o,n,a,l){let[h,c]=this.lastPoint;if(Math.sqrt((s-h)**2+(o-c)**2)<_t)return;e.lineTo((s-n)/l,(o-a)/l);let d=getComputedStyle(document.body).getPropertyValue("--color-"+this.color+"-font");e.strokeStyle=d+this.transparency,e.lineWidth=this.lineWidth/l,e.stroke(),this.points.push([s,o]),this.lastPoint=[s,o]}onEnd(t,e,s,o,n,a,l){e.lineTo((s-n)/l,(o-a)/l);let h=getComputedStyle(document.body).getPropertyValue("--color-"+this.color+"-font");e.strokeStyle=h+this.transparency,e.lineWidth=this.lineWidth/l,e.stroke(),e.closePath(),this.points.push([s,o]);let[c,d]=this.normalizePoints(this.points,this.lineWidth);this.points=[],t.addElements([{uuid:W(),type:this.id,layer:wt,bbox_xyxy:d,data:[this.color,this.lineWidth,c]}])}normalizePoints(t,e){let s=t[0][0],o=t[0][1],[n,a,l,h]=[s,o,s,o];for(let d of t)n=Math.min(n,d[0]),a=Math.min(a,d[1]),l=Math.max(l,d[0]),h=Math.max(h,d[1]);n-=5+e,a-=5+e,l+=5+e,h+=5+e;let c=[];n=f(n),l=f(l),a=f(a),h=f(h);for(let d of t)c.push([f(d[0]-n),f(d[1]-a)]);return[c,[n,a,l,h]]}activate(){}deactivate(){}}function k(r){let i=[Math.min(r[0][0],r[1][0]),Math.min(r[0][1],r[1][1])],t=[Math.max(r[0][0],r[1][0]),Math.max(r[0][1],r[1][1])];return[i,t]}function B(r,i){return r[0][0]<=i[1][0]&&r[1][0]>=i[0][0]&&r[0][1]<=i[1][1]&&r[1][1]>=i[0][1]}function Ct(r,i){const t=i[0][0]-r[0][0],e=i[0][1]-r[0][1],s=r[1][0]-r[0][0],o=r[1][1]-r[0][1],n=i[1][0]-i[0][0],a=i[1][1]-i[0][1],l=s*a-o*n;if(l!=0){const h=t*a-e*n,c=t*o-e*s,d=h/l,p=c/l;if(0<=d&&d<=1&&0<=p&&p<=1)return!0}return!1}let Et=["pen","marker"];class Tt extends G{constructor(t){super(t,at,"erasor");u(this,"x0",0);u(this,"y0",0)}onStart(t,e,s,o,n,a,l){this.x0=s,this.y0=o}onMove(t,e,s,o,n,a,l){if(s!=this.x0&&o!=this.y0){let h=[],c=[[this.x0,this.y0],[s,o]];this.drawDebugLine(e,c,n,a,l,"#FF000033",1),t.getDocument().forEach((d,p)=>{if(!Et.includes(d.type))return;let w=[[d.bbox_xyxy[0],d.bbox_xyxy[1]],[d.bbox_xyxy[2],d.bbox_xyxy[3]]];if(B(k(c),w)){let g=d.data[2],y=d.bbox_xyxy[0],x=d.bbox_xyxy[1];for(let v=1;v<g.length;v++){let _=[g[v-1],g[v]];if(_=[[_[0][0]+y,_[0][1]+x],[_[1][0]+y,_[1][1]+x]],B(k(c),k(_))&&Ct(_,c)){h.push(d);return}}}}),h.length>0&&t.deleteElements(h),this.x0=s,this.y0=o}}drawDebugLine(t,e,s,o,n,a,l){t.beginPath(),t.moveTo((e[0][0]-s)/n,(e[0][1]-o)/n),t.lineTo((e[1][0]-s)/n,(e[1][1]-o)/n),t.strokeStyle=a,t.lineWidth=l,t.stroke(),t.closePath()}onEnd(t,e,s,o,n,a,l){this.onMove(t,e,s,o,n,a,l),t.requestRedraw()}}class St extends G{constructor(t){super(t,rt,"insertSpace");u(this,"movingElements",[]);u(this,"lastY",0)}onStart(t,e,s,o){this.movingElements=[];let n=t.getDocument();for(let[a,l]of n)o<l.bbox_xyxy[1]&&this.movingElements.push(l);this.lastY=o}onMove(t,e,s,o){for(let n of this.movingElements){let a=o-this.lastY;n.bbox_xyxy[1]=f(n.bbox_xyxy[1]+a),n.bbox_xyxy[3]=f(n.bbox_xyxy[3]+a)}this.lastY=o,t.modifyElements(this.movingElements,!0)}onEnd(t,e,s,o){this.onMove(t,e,s,o)}}let Mt='<svg xmlns="http://www.w3.org/2000/svg" height="1em" viewBox="0 0 448 512"><!--! Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2023 Fonticons, Inc. --><path d="M16 132h416c8.837 0 16-7.163 16-16V76c0-8.837-7.163-16-16-16H16C7.163 60 0 67.163 0 76v40c0 8.837 7.163 16 16 16zm0 160h416c8.837 0 16-7.163 16-16v-40c0-8.837-7.163-16-16-16H16c-8.837 0-16 7.163-16 16v40c0 8.837 7.163 16 16 16zm0 160h416c8.837 0 16-7.163 16-16v-40c0-8.837-7.163-16-16-16H16c-8.837 0-16 7.163-16 16v40c0 8.837 7.163 16 16 16z"/></svg>',Lt='<svg xmlns="http://www.w3.org/2000/svg" height="1em" viewBox="0 0 352 512"><!--! Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2023 Fonticons, Inc. --><path d="M242.72 256l100.07-100.07c12.28-12.28 12.28-32.19 0-44.48l-22.24-22.24c-12.28-12.28-32.19-12.28-44.48 0L176 189.28 75.93 89.21c-12.28-12.28-32.19-12.28-44.48 0L9.21 111.45c-12.28 12.28-12.28 32.19 0 44.48L109.28 256 9.21 356.07c-12.28 12.28-12.28 32.19 0 44.48l22.24 22.24c12.28 12.28 32.2 12.28 44.48 0L176 322.72l100.07 100.07c12.28 12.28 32.2 12.28 44.48 0l22.24-22.24c12.28-12.28 12.28-32.19 0-44.48L242.72 256z"/></svg>';class Ot extends C{constructor(i,t){super("div","","toolbar"),t&&this.add(new E("back",!1,it));let e=new E("save",!1,ct);b.register("save",(o,n)=>{n.type=="saved"?e.htmlElement.style.fill="var(--color-brand-c1)":e.htmlElement.style.fill="var(--color-bad-font)"}),this.add(e),this.add(new ot),new Pt(this).register(i),new bt(this).register(i),new Tt(this).register(i),new St(this).register(i);let s=new E("menu",!1,Mt,!0,!1);s.addPopup(new st([new N("clear",dt,"Clear"),new N("export",ut,"Export"),new N("import",pt,"Import")])),this.add(s),this.add(new E("touchToggle",!1,ht,!0,!0))}}function It(r,i){let t=new PointerEvent("mouse"),e=new PointerEvent("pen"),s=new TouchEvent("touch"),o=!1,n=0,a=!1;r.addEventListener("touchstart",function(l){l.preventDefault(),l.targetTouches.length==1&&i.onTouchStart(l),l.targetTouches.length==2&&i.onPinchStart(l),s=l}),r.addEventListener("touchmove",function(l){l.preventDefault(),s.targetTouches.length==1&&(l.targetTouches.length==1?i.onTouchMove(l,s):i.onTouchEnd(l,s),l.targetTouches.length==2&&i.onPinchStart(l)),s.targetTouches.length==2&&(l.targetTouches.length==2?i.onPinchMove(l,s):i.onPinchEnd(l,s),l.targetTouches.length==1&&i.onTouchStart(l)),s=l}),r.addEventListener("touchend",function(l){l.preventDefault(),s.targetTouches.length==1?i.onTouchEnd(l,s):s.targetTouches.length==2&&i.onPinchEnd(l,s),s=l}),r.addEventListener("pointerdown",function(l){l.preventDefault(),l.pointerType=="mouse"&&!o?(o=!0,n=l.button,i.onMouseStart(l,n),t=l):l.pointerType=="pen"&&!a&&(a=!0,i.onPenStart(l),e=l)}),r.addEventListener("pointermove",function(l){l.preventDefault(),l.pointerType=="mouse"&&o?(i.onMouseMove(l,n,t),t=l):l.pointerType=="pen"&&a&&(i.onPenMove(l,e),e=l)}),r.addEventListener("pointerup",function(l){l.preventDefault(),l.pointerType=="mouse"&&o&&l.button==n?(i.onMouseEnd(l,n,t),o=!1,t=l):l.pointerType=="pen"&&a&&(i.onPenEnd(l,e),a=!1,e=l)})}class q extends C{constructor(t,e){var s;super("div");u(this,"container");this.setClass(t),this.container=new C("div"),this.container.setClass(e),this.container.add(this),(s=document.getElementById("global"))==null||s.appendChild(this.container.htmlElement)}dispose(){var t;this.onExit(),(t=document.getElementById("global"))==null||t.removeChild(this.container.htmlElement)}onExit(){}update(){}}class At extends q{constructor(i,t,e,s,o){super(i,t),this.add(new C("p",e));let n=new L(s,"popupConfirmBtn");n.onClick=()=>{this.dispose(),this.onConfirm()},this.add(n);let a=new L(o,"popupCancelBtn");a.onClick=()=>{this.dispose(),this.onCancel()},this.add(a)}onConfirm(){console.log("ConfirmCancelPopup::onConfirm not implemented. Must be implemented by subclass.")}onCancel(){console.log("ConfirmCancelPopup::onCancel not implemented. Must be implemented by subclass.")}}class Nt extends q{constructor(i="popupContent",t="popupContainer",e="popupExitBtn"){super(i,t);let s=new L(Lt,e);s.onClick=this.dispose.bind(this),this.add(s)}update(){}}function kt(r,i,t){return'<svg width="'+i+'" height="'+t+`" xmlns="http://www.w3.org/2000/svg">
`+r+"</svg>"}function Rt(r,i,t){let e=[];for(let s of r)e.push(s[0]+","+s[1]);return'<polyline points="'+e.join(" ")+'" style="fill:none;stroke:'+i+";stroke-width:"+t+`" />
`}function Ft(r){return`<!--
`+r+`
-->
`}let M=210,R=297;class Dt extends C{constructor(t,e="",s=!1){super("div","",e);u(this,"tools",new Map);u(this,"canvasContainer");u(this,"layers",new Map);u(this,"textures",new Map);u(this,"pageElements",new Map);u(this,"canvas");u(this,"context");u(this,"offscreenCanvas");u(this,"offscreenContext");u(this,"activeTool","pen");u(this,"isTouchAllowed",!1);u(this,"offset",[0,0]);u(this,"scale",1.05);u(this,"deviceScale",1);u(this,"lowestEntity",0);u(this,"saving",null);u(this,"mousePos",[0,0]);u(this,"background","grid");this.add(new Ot(this.tools,s)),this.canvasContainer=new C("div","","notepad-canvasContainer"),this.add(this.canvasContainer),this.canvas=document.createElement("canvas"),this.offscreenCanvas=document.createElement("canvas"),this.canvasContainer.htmlElement.appendChild(this.canvas),this.context=this.canvas.getContext("2d",{desynchronized:!0}),this.offscreenContext=this.offscreenCanvas.getContext("2d"),window.onresize=this.resizeHandler.bind(this),b.register("toolbar/change",this.onToolbarChange.bind(this)),this.canvas.oncontextmenu=()=>!1,this.canvas.addEventListener("pointermove",this.computeRawPointerPosition.bind(this)),It(this.canvas,this),this.canvas.addEventListener("wheel",this.scroll.bind(this),!1),this.setData(t),window.setTimeout(this.resizeHandler.bind(this),100)}onBack(t){alert("Notepad::onBack has to be implemented by user.")}onSave(t){alert("Notepad::onSave has to be implemented by user.")}save(){this.onSave(this.getData()),b.send("save",{allowNetwork:!1,data:null,type:"saved"})}getData(){const t=Array.from(this.getDocument().values());return JSON.stringify({version:"1.1",elements:t})}setData(t){if(this.deleteElements(this.getDocument().values(),!1),!t||t=="")return;let e=JSON.parse(t);if(e.version===void 0){for(const s in e){let o=e[s],n=o.bbox_xyxy;if(o.bbox_xyxy=[f(n[0]/7),f(n[1]/7),f(n[2]/7),f(n[3]/7)],o.type=="pen"||o.type=="marker"){o.data[1]=f(o.data[1]/7);for(const a in o.data[2])o.data[2][a][0]=f(o.data[2][a][0]/7),o.data[2][a][1]=f(o.data[2][a][1]/7)}}e={version:"0",elements:e},this.delayedAutosave()}if(e.version=="1")for(const s in e.elements){let o=e.elements[s],n=o.bbox_xyxy;if(o.bbox_xyxy=[f(n[0]),f(n[1]),f(n[2]),f(n[3])],o.type=="pen"||o.type=="marker"){o.data[1]=f(o.data[1]);for(const a in o.data[2])o.data[2][a][0]=f(o.data[2][a][0]),o.data[2][a][1]=f(o.data[2][a][1])}}this.addElements(e.elements,!1)}delayedAutosave(){this.saving!=null&&window.clearTimeout(this.saving),b.send("save",{allowNetwork:!1,data:null,type:"dirty"}),this.saving=window.setTimeout(this.save.bind(this),5e3)}scroll(t){t.deltaY>0?this.changeScale(1.1,this.mousePos):this.changeScale(1/1.1,this.mousePos)}changeScale(t,e){let s=this.scale,o=this.canvas.getBoundingClientRect(),n=o.width*this.scale,a=o.height*this.scale,l=this.offset[0],h=this.offset[1];this.scale*=t,this.scale<.25*this.deviceScale&&(this.scale=.25*this.deviceScale),this.scale>5*this.deviceScale&&(this.scale=5*this.deviceScale);let c=this.scale/s;l+=(1-c)*n*e[0],h+=(1-c)*a*e[1],this.offset[0]=l,this.offset[1]=h,this.limitOffset(),this.requestRedraw()}onMouseStart(t,e){var h;let s=this.computeRawPointerPosition(t),{x:o,y:n,dx:a,dy:l}=this.computeVirtualPosition(s);e==0&&((h=this.tools.get(this.activeTool))==null||h.onStart(this,this.context,o,n,a,l,this.scale))}onMouseMove(t,e,s){var c;let o=this.computeRawPointerPosition(t),{x:n,y:a,dx:l,dy:h}=this.computeVirtualPosition(o);if(e==0&&((c=this.tools.get(this.activeTool))==null||c.onMove(this,this.context,n,a,l,h,this.scale)),e==1||e==2){let d=this.computeRawPointerPosition(s),p=this.computeVirtualPosition(d);this.offset[0]+=p.x-n,this.offset[1]+=p.y-a,this.limitOffset(),this.requestRedraw()}}onMouseEnd(t,e,s){var c;let o=this.computeRawPointerPosition(t),{x:n,y:a,dx:l,dy:h}=this.computeVirtualPosition(o);e==0&&((c=this.tools.get(this.activeTool))==null||c.onEnd(this,this.context,n,a,l,h,this.scale))}onPenStart(t){var l;let e=this.computeRawPointerPosition(t),{x:s,y:o,dx:n,dy:a}=this.computeVirtualPosition(e);(l=this.tools.get(this.activeTool))==null||l.onStart(this,this.context,s,o,n,a,this.scale)}onPenMove(t,e){var h;let s=this.computeRawPointerPosition(t),{x:o,y:n,dx:a,dy:l}=this.computeVirtualPosition(s);(h=this.tools.get(this.activeTool))==null||h.onMove(this,this.context,o,n,a,l,this.scale)}onPenEnd(t,e){var h;let s=this.computeRawPointerPosition(t),{x:o,y:n,dx:a,dy:l}=this.computeVirtualPosition(s);(h=this.tools.get(this.activeTool))==null||h.onEnd(this,this.context,o,n,a,l,this.scale)}onTouchStart(t){}onTouchMove(t,e){if(this.isTouchAllowed){let s=this.computeRawTouchPositions(t)[0],{x:o,y:n}=this.computeVirtualPosition(s),a=this.computeRawTouchPositions(e)[0],l=this.computeVirtualPosition(a);this.offset[0]+=l.x-o,this.offset[1]+=l.y-n,this.limitOffset(),this.requestRedraw()}}onTouchEnd(t,e){}onPinchStart(t){}onPinchMove(t,e){if(this.isTouchAllowed){let[s,o]=this.computeRawTouchPositions(t),[n,a]=this.computeRawTouchPositions(e),l=Math.sqrt((s[0]-o[0])**2+(s[1]-o[1])**2),h=Math.sqrt((n[0]-a[0])**2+(n[1]-a[1])**2),c=[(s[0]+o[0])/2,(s[1]+o[1])/2],d=[(n[0]+a[0])/2,(n[1]+a[1])/2],p=h/l;if(!isNaN(p)){let{x:w,y:g}=this.computeVirtualPosition(c),y=this.computeVirtualPosition(d);this.offset[0]+=y.x-w,this.offset[1]+=y.y-g;let x=this.canvas.getBoundingClientRect();this.changeScale(p,[c[0]/x.width,c[1]/x.height])}}}onPinchEnd(t,e){}computeRawPointerPosition(t){let e=this.canvas.getBoundingClientRect(),s=t.x-e.left,o=t.y-e.top;return t.pointerType=="mouse"&&(this.mousePos[0]=s/e.width,this.mousePos[1]=o/e.height),[s,o]}computeRawTouchPositions(t){let e=this.canvas.getBoundingClientRect(),s=[];for(let o=0;o<t.targetTouches.length;o++){let n=t.targetTouches[o],a=n.clientX-e.left,l=n.clientY-e.top;s.push([a,l])}return s}computeVirtualPosition(t){let e=this.offset[0],s=this.offset[1],o=t[0]*this.scale+e,n=t[1]*this.scale+s;return{x:o,y:n,dx:e,dy:s}}limitOffset(){M/this.scale<this.canvas.width?this.offset[0]=M/2-this.canvas.width/2*this.scale:(this.offset[0]=Math.min(this.offset[0],M-this.scale*this.canvas.width*19/20),this.offset[0]=Math.max(this.offset[0],-this.scale*this.canvas.width/20)),this.offset[1]=Math.min(this.offset[1],this.lowestEntity-this.scale*this.canvas.height/20),this.offset[1]=Math.max(this.offset[1],-this.scale*this.canvas.height/20)}getDocument(){return this.pageElements}addElements(t,e=!0){this.modifyElements(t,!1,e)}modifyElements(t,e=!1,s=!0){if(!e)for(let o of t){let n=o.type;this.tools.has(n)||alert("Unsupported tool please let the dev know: "+n);let l=this.tools.get(n).render(o);this.pageElements.set(o.uuid,o),this.textures.set(o.uuid,l),this.layers.has(o.layer)||this.layers.set(o.layer,[]);let h=this.layers.get(o.layer);h.indexOf(o.uuid)==-1&&h.push(o.uuid)}this.lowestEntity=0;for(let[o,n]of this.pageElements)this.lowestEntity=Math.max(n.bbox_xyxy[3],this.lowestEntity);this.requestRedraw(),s&&this.delayedAutosave()}deleteElements(t,e=!0){for(let s of t){this.pageElements.delete(s.uuid),this.textures.delete(s.uuid);let o=this.layers.get(s.layer),n=o.indexOf(s.uuid);n>-1&&o.splice(n,1)}this.requestRedraw(),e&&this.delayedAutosave()}requestRedraw(){window.requestAnimationFrame(this.render.bind(this))}render(){let t=this.canvas.width,e=this.canvas.height,s=getComputedStyle(document.body).getPropertyValue("--color-base");this.offscreenContext.fillStyle=s,this.offscreenContext.fillRect(0,0,t,e);let o=Array.from(this.layers.keys());o=o.sort();let n=this.offset[0],a=this.offset[1];for(let c=0;c<2;c++){let d=(M*c-n)/this.scale;this.offscreenContext.beginPath(),this.offscreenContext.moveTo(d,0),this.offscreenContext.lineTo(d,e);let p=getComputedStyle(document.body).getPropertyValue("--color-bad-font");this.offscreenContext.strokeStyle=p+"AA",this.offscreenContext.lineWidth=2,this.offscreenContext.stroke(),this.offscreenContext.closePath()}let l=Math.ceil(this.canvas.height/(R/this.scale)),h=Math.floor(a/R)+1;for(let c=0;c<l;c++){let d=(R*(c+h)-a)/this.scale;this.offscreenContext.beginPath(),this.offscreenContext.moveTo(0,d),this.offscreenContext.lineTo(t,d);let p=getComputedStyle(document.body).getPropertyValue("--color-bad-font");this.offscreenContext.strokeStyle=p+"AA",this.offscreenContext.lineWidth=2,this.offscreenContext.stroke(),this.offscreenContext.closePath()}this.background=="grid"?this.drawGrid(this.offscreenContext,n,a,t,e):this.background=="lines"&&this.drawLines(this.offscreenContext,n,a,t,e);for(let c of o){let d=this.layers.get(c);for(let p of d){let w=this.pageElements.get(p),g=this.textures.get(p),[y,x,v,_]=w.bbox_xyxy;y=(y-n)/this.scale,x=(x-a)/this.scale,v=(v-n)/this.scale,_=(_-a)/this.scale,(0<=y&&y<=t&&0<=x&&x<=e||0<=v&&v<=t&&0<=_&&_<=e)&&this.offscreenContext.drawImage(g,y,x,v-y,_-x)}}this.context.drawImage(this.offscreenCanvas,0,0,this.canvas.width,this.canvas.height)}drawLines(t,e,s,o,n){let a=10,l=Math.ceil(n/(a/this.scale)),h=Math.floor(s/100)+1;for(let c=0;c<l;c++){let d=(a*(c+h)-s)/this.scale;t.beginPath(),t.moveTo(0,d),t.lineTo(o,d);let p=getComputedStyle(document.body).getPropertyValue("--color-base-hover");t.strokeStyle=p+"AA",t.lineWidth=1,t.stroke(),t.closePath()}}drawGrid(t,e,s,o,n){let a=5,l=Math.ceil(n/(a/this.scale)),h=Math.floor(s/a)+1;for(let p=0;p<l;p++){let w=(a*(p+h)-s)/this.scale;t.beginPath(),t.moveTo(0,w),t.lineTo(o,w);let g=getComputedStyle(document.body).getPropertyValue("--color-base-hover");t.strokeStyle=g+"AA",t.lineWidth=1,t.stroke(),t.closePath()}let c=Math.ceil(o/(a/this.scale)),d=Math.floor(e/a)+1;for(let p=0;p<c;p++){let w=(a*(p+d)-e)/this.scale;t.beginPath(),t.moveTo(w,0),t.lineTo(w,n);let g=getComputedStyle(document.body).getPropertyValue("--color-base-hover");t.strokeStyle=g+"AA",t.lineWidth=1,t.stroke(),t.closePath()}}onToolbarChange(t,e){var s,o;if(e.type=="string"&&e.data.indexOf("tool_")==0){let n=this.activeTool;this.activeTool=e.data.substring(5),n!=this.activeTool&&((s=this.tools.get(n))==null||s.deactivate(),(o=this.tools.get(this.activeTool))==null||o.activate(),console.log("Switched tool to: "+this.activeTool))}else if(e.type=="string"&&e.data=="touchToggle")this.isTouchAllowed=!this.isTouchAllowed;else if(e.type=="string"&&e.data=="save")this.saving!=null&&window.clearTimeout(this.saving),this.save();else if(e.type=="string"&&e.data=="back")this.saving!=null?(window.clearTimeout(this.saving),this.onBack(!0)):this.onBack(!1);else if(e.type=="string"&&e.data=="export"){let n=new Date().toISOString().substring(0,19).replace("T","_").replaceAll(":",""),a=this.getSVG();this.saveToLocalTextFile(a,n+"_Note.spf.svg")}else if(e.type=="string"&&e.data=="import"){let n=new Nt;n.add(new C("div",T.NOTEPAD_IMPORT_QUESTION,"notepad-importHeader"));let a=new tt("importFile","*.spf.svg or *.spf","file","notepad-importFile");n.add(a);let l=new L(T.NOTEPAD_IMPORT_CONFIRM,"notepad-importConfirm"),h=this;l.onClick=()=>{var d;if((d=a.htmlElement.files)!=null&&d.length){let p=a.htmlElement.files[0];if(!p.name.endsWith(".spf.svg")&&!p.name.endsWith(".spf")){alert(T.NOTEPAD_IMPORT_UNSUPPORTED_FILE);return}var c=new FileReader;c.onload=function(w){let g=w.target;if(g!=null){let y=g.result;if(p.name.endsWith(".spf.svg")){let x=y.indexOf(`<!--
`),v=y.indexOf(`
-->`);y=y.slice(x+5,v)}h.setData(y),b.send("save",{allowNetwork:!1,data:null,type:"dirty"}),n.dispose()}},c.readAsBinaryString(p)}},n.add(l),n.show()}else if(e.type=="string"&&e.data=="clear"){let n="popupContent",a="popupContainer",l=new At(n,a,T.NOTEPAD_CLEAR_QUESTION,T.NOTEPAD_CLEAR_CANCEL,T.NOTEPAD_CLEAR_CONFIRM);l.onConfirm=()=>{},l.onCancel=()=>{this.deleteElements(this.getDocument().values(),!1),b.send("save",{allowNetwork:!1,data:null,type:"dirty"})},l.show()}}getSVG(){let t=1,e=0,s=0,o=1e5,n=1e5,a="";a+=Ft(this.getData());let l=Array.from(this.layers.keys());l=l.sort();for(let h of l){let c=this.layers.get(h);for(let d of c){let p=this.pageElements.get(d);console.log(p.type);let[w,g,y,x]=p.bbox_xyxy;y>e&&(e=y),x>s&&(s=x),w<o&&(o=w),g<n&&(n=g)}}for(let h of l){let c=this.layers.get(h);for(let d of c){let p=this.pageElements.get(d);console.log(p.type);let[w,g,y,x]=p.bbox_xyxy,v=p.type;if(this.tools.has(v)||alert("Unsupported tool please let the dev know: "+v),v=="pen"||v=="marker"){let _=this.tools.get(v),A=getComputedStyle(document.body).getPropertyValue("--color-"+p.data[0]+"-font");A=A+_.getTransparancy();let X=p.data[1]*t,D=[];for(let V of p.data[2]){let K=w+V[0]*t,Q=g+V[1]*t;D.push([K-o,Q-n])}let j=Rt(D,A,X);a+=j}}}return kt(a,e-o,s-n)}saveToLocalTextFile(t,e){let s=new Blob([t],{type:"text/plain"}),o=document.createElement("a");o.href=window.URL.createObjectURL(s),o.download=typeof e=="string"?e:"download",o.target="_blank",o.click(),o.remove()}resizeHandler(){this.canvas.width=this.canvasContainer.htmlElement.clientWidth,this.canvas.height=this.canvasContainer.htmlElement.clientHeight,this.offscreenCanvas.width=this.canvas.width,this.offscreenCanvas.height=this.canvas.height;let t=this.deviceScale;this.deviceScale=M/this.canvas.width,this.scale=this.scale/t*this.deviceScale,this.limitOffset(),this.requestRedraw(),console.log("resized")}}async function Vt(){for(let i in localStorage)i.startsWith("sp_")&&i!="sp_file"&&delete localStorage[i];Z();let r=new Dt(localStorage.sp_file,"",!1);r.onSave=i=>{localStorage.sp_file=i},r.onBack=()=>{alert("This should not happen!")},document.addEventListener("keydown",i=>{i.ctrlKey&&i.key==="s"&&(i.preventDefault(),r.save())}),document.getElementsByTagName("title")[0].innerHTML=T.APPNAME,document.getElementById("app").appendChild(r.htmlElement)}Vt();
